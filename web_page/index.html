<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Elyx Member Journey - Advanced Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Navigation Menu -->
  <nav style="margin:1em; text-align:center;">
    <a href="index.html">Chat</a> |
    <a href="metrics.html">Metrics</a> |
    <a href="plans.html">Plan</a>
  </nav>

  <!-- Header -->
  <header>
    <h1>Elyx Member Journey</h1>
    <p>WhatsApp-style visualization with search, highlight, grouping, and download</p>
  </header>

  <!-- Controls -->
  <div id="controls">
    <input type="text" id="search-input" placeholder="Search by sender or text..." />
    <input type="date" id="date-filter" />
    <button id="download-chat">Download Visible Chat</button>
  </div>

  <!-- Chat container -->
  <div id="chat-container">
    <!-- Chat messages rendered here -->
  </div>

  <script>
    // Sample simulated chat data (replace with real data or fetch)
    const conversations = [
      {
        timestamp: new Date("2025-01-15T09:00:00"),
        sender: "Rohan Patel",
        sender_role: "Member",
        message: "Hi Ruby. My Garmin is logging high intensity minutes even on rest days. Need a medical review."
      },
      {
        timestamp: new Date("2025-01-15T09:00:00"),
        sender: "Rachel",
        sender_role: "PT",
        message: "Time for your exercise program update for week 1. We'll adapt based on your progress."
      },
      {
        timestamp: new Date("2025-01-15T09:14:24"),
        sender: "Ruby",
        sender_role: "Concierge",
        message: "Thank you, Rohan. Are you experiencing other symptoms? I'll flag Dr. Warren recommendation for follow-up."
      }
    ];

    // Render chat messages to the page
    function renderChats(filteredChats) {
      const container = document.getElementById('chat-container');
      container.innerHTML = '';  // Clear old chats

      filteredChats.forEach(conv => {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');

        // Style bubble based on sender role
        if (conv.sender_role === 'Member') {
          bubble.classList.add('member');
        } else {
          bubble.classList.add('team');
        }

        // Format timestamp nicely
        const timeStr = conv.timestamp.toLocaleString('en-GB', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });

        // Construct message content with sender and timestamp
        bubble.innerHTML = `
          <div class="sender">${conv.sender} <span class="role">(${conv.sender_role})</span></div>
          <div class="message-text">${conv.message}</div>
          <div class="timestamp">${timeStr}</div>
        `;

        container.appendChild(bubble);
      });

      // Call to append "Why?" buttons on doctor suggestions
      enhanceDoctorSuggestions();
    }

    // Filter chats on search/lDate
    function filterChats() {
      const searchVal = document.getElementById('search-input').value.toLowerCase();
      const dateVal = document.getElementById('date-filter').value;
      let filtered = conversations;

      if (searchVal) {
        filtered = filtered.filter(c => 
          c.sender.toLowerCase().includes(searchVal) || c.message.toLowerCase().includes(searchVal)
        );
      }

      if (dateVal) {
        filtered = filtered.filter(c => 
          c.timestamp.toISOString().slice(0,10) === dateVal
        );
      }

      renderChats(filtered);
    }

    // Enhance doctor suggestions to add "Why?" button and explanations
    function enhanceDoctorSuggestions() {
      const doctorBubbles = document.querySelectorAll(".bubble.team");

      doctorBubbles.forEach(bubble => {
        const msgTextEl = bubble.querySelector(".message-text");
        if (!msgTextEl) return;
        const messageText = msgTextEl.textContent || "";

        // Add "Why?" button if message seems like a suggestion or recommendation
        if (/suggestion|recommendation|recommend/i.test(messageText)) {
          if (!bubble.querySelector(".why-button")) {
            const btn = document.createElement("button");
            btn.textContent = "Why?";
            btn.className = "why-button";

            const explanation = document.createElement("div");
            explanation.className = "explanation-text";
            explanation.textContent = "This suggestion is based on patient's recent health data and medical guidelines.";
            explanation.style.display = "none";

            btn.addEventListener("click", () => {
              explanation.style.display = explanation.style.display === "none" ? "block" : "none";
            });

            bubble.appendChild(btn);
            bubble.appendChild(explanation);
          }
        }
      });
    }

    // Download filtered chat as JSON
    function downloadChat() {
      const dataStr = JSON.stringify(conversations, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "visible_chat.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Event listeners
    document.getElementById('search-input').addEventListener('input', filterChats);
    document.getElementById('date-filter').addEventListener('change', filterChats);
    document.getElementById('download-chat').addEventListener('click', downloadChat);

    // Initial render
    renderChats(conversations);
  </script>
</body>
</html>

