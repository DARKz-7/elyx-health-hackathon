<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Elyx Member Journey - Advanced Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav style="margin:1em; text-align:center;">
    <a href="index.html">Chat</a> |
    <a href="metrics.html">Metrics</a> |
    <a href="plans.html">Plan</a>
  </nav>

  <header>
    <h1>Elyx Member Journey</h1>
    <p>WhatsApp-style visualization with search, highlight, grouping, and download</p>
  </header>

  <div id="controls">
    <input type="text" id="search-input" placeholder="Search by sender or text..." />
    <input type="date" id="date-filter" />
    <button id="download-chat">Download Visible Chat</button>
  </div>

  <div id="chat-container"></div>

  <script>
    let conversations = [];

    // Explanation texts keyed by explanation_id
    const explanationAPI = {
      pt_plan_update: "Exercise programs are adjusted based on progress to maximize improvement while preventing injury.",
      report_1: "Autonomic dysfunction explains symptoms; we require records to rule out other causes and tailor treatment.",
      travel_workout: "This circuit adapts your exercise for limited hotel space and equipment, maintaining your routine while traveling.",
      concierge_update: "The concierge facilitates communication and coordination to ensure memberâ€™s concerns are addressed promptly.",
      reminder_diagnostic_panel: "Regular diagnostic panels every 3 months allow tracking health progress and adjusting care plans effectively."
      // Add more mappings here if you expand your JSON
    };

    async function fetchExplanation(id) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve(explanationAPI[id] || "No detailed explanation available.");
        }, 150);
      });
    }

    async function loadChats() {
      const res = await fetch('data/conversations.json');  // Path updated to 'data' folder
      const data = await res.json();
      conversations = data.map(c => ({ ...c, timestamp: new Date(c.timestamp) }));
      renderChats(conversations);
    }

    async function renderChats(filteredChats) {
      const container = document.getElementById('chat-container');
      container.innerHTML = '';

      for (let conv of filteredChats) {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');

        if (conv.sender_role && ["Doctor", "PT", "Concierge", "Coach", "Medical Strategist"].includes(conv.sender_role)) {
          bubble.classList.add('team');
        } else {
          bubble.classList.add('member');
        }

        if (conv.explanation_id) {
          bubble.classList.add('suggestion');
        }

        const timeStr = conv.timestamp.toLocaleString('en-GB', {
          day:'2-digit', month:'2-digit', year:'numeric',
          hour:'2-digit', minute:'2-digit'
        });

        bubble.innerHTML = `
          <div class="sender">${conv.sender} <span class="role">(${conv.sender_role || ''})</span></div>
          <div class="message-text">${conv.message}</div>
          <div class="timestamp">${timeStr}</div>
        `;

        if (conv.explanation_id) {
          const btn = document.createElement('button');
          btn.textContent = "Why?";
          btn.className = 'why-button';

          const explanationDiv = document.createElement('div');
          explanationDiv.className = 'explanation-text';

          let loaded = false;
          btn.onclick = async () => {
            document.querySelectorAll('.explanation-text.open').forEach(el => el.classList.remove('open'));

            if (!loaded) {
              explanationDiv.textContent = "Loading explanation...";
              explanationDiv.classList.add('open');
              explanationDiv.textContent = await fetchExplanation(conv.explanation_id);
              loaded = true;
            } else {
              explanationDiv.classList.toggle('open');
            }
          };

          bubble.appendChild(btn);
          bubble.appendChild(explanationDiv);
        }

        container.appendChild(bubble);
      }
    }

    function filterChats() {
      const searchVal = document.getElementById('search-input').value.toLowerCase();
      const dateVal = document.getElementById('date-filter').value;
      let filtered = conversations;

      if (searchVal) filtered = filtered.filter(c =>
        (c.sender && c.sender.toLowerCase().includes(searchVal)) ||
        (c.message && c.message.toLowerCase().includes(searchVal))
      );

      if (dateVal) filtered = filtered.filter(c =>
        c.timestamp.toISOString().slice(0,10) === dateVal
      );

      renderChats(filtered);
    }

    function downloadChat() {
      const dataStr = JSON.stringify(conversations, null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "visible_chat.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    document.getElementById('search-input').addEventListener('input', filterChats);
    document.getElementById('date-filter').addEventListener('change', filterChats);
    document.getElementById('download-chat').addEventListener('click', downloadChat);

    loadChats();
  </script>
</body>
</html>

