<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Care Plan Gantt Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif; 
      padding: 2em;
      background: #fafafa;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.2em;
    }
    p.subtitle {
      text-align: center;
      font-weight: 400;
      color: #555;
      margin-bottom: 2em;
    }
    .gantt-container {
      max-width: 1100px;
      margin: 0 auto;
      overflow-x: auto;
      border: 1px solid #ccc;
      background: white;
      padding: 2em 1em 2em 7em;
      border-radius: 8px;
      position: relative;
    }
    .y-labels {
      position: absolute;
      left: 0;
      top: 3.8em;
      width: 6em;
      z-index: 2;
      font-weight: 600;
      color: #444;
      font-size: 0.95em;
    }
    .y-label {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      white-space: nowrap;
    }
    .gantt-timeline {
      position: relative;
      height: 40px;
      margin-bottom: 8px;
    }
    .x-labels {
      display: flex;
      margin-left: 6em;
      margin-bottom: 1em;
      font-size: 0.96em;
      font-weight: bold;
      color: #666;
    }
    .x-label {
      flex: 1;
      text-align: center;
    }
    .gantt-bar {
      position: absolute;
      height: 28px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      padding-left: 15px;
      padding-right: 15px;
      display: flex;
      align-items: center;
      white-space: nowrap;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.09);
      font-size: 0.95em;
      top: 6px;
      transition: transform 0.14s;
    }
    .gantt-bar:hover {
      transform: scale(1.04);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      z-index: 10;
    }
    .badge {
      display: inline-block;
      margin-left: 10px;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 0.75rem;
      font-weight: 700;
      line-height: 1;
      user-select: none;
    }
    .active { background-color: #27ae60; }
    .scheduled { background-color: #3498db; }
    .pending { background-color: #f1c40f; color: #444; }
    .completed { background-color: #7f8c8d; }
    .tooltip {
      position: absolute;
      background: #222;
      color: white;
      padding: 0.5em 1em;
      border-radius: 6px;
      font-size: 0.85rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.28s;
      max-width: 320px;
      line-height: 1.3;
      z-index: 100;
    }
    @media (max-width:700px){
      .gantt-container{padding-left:2em;}
      .y-labels{width:4em;}
    }
  </style>
</head>
<body>
  <h1>Care Plan & Interventions Gantt Chart</h1>
  <p class="subtitle">Each intervention gets its own row. Hover bars for full details.</p>
  <div class="gantt-container">
    <div class="x-labels" id="x-labels"></div>
    <div class="y-labels" id="y-labels"></div>
    <div id="gantt-timelines"></div>
  </div>
  <div class="tooltip" id="tooltip"></div>
  <script>
    const tooltip = document.getElementById('tooltip');
    const xLabels = document.getElementById('x-labels');
    const yLabelsDiv = document.getElementById('y-labels');
    const timelinesDiv = document.getElementById('gantt-timelines');

    function parseDate(str) {
      return new Date(str + 'T00:00:00');
    }

    function getMonthLabels(start, end) {
      const labels = [];
      const s = new Date(start);
      const e = new Date(end);
      s.setDate(1);
      e.setDate(1);
      while (s <= e) {
        labels.push({year: s.getFullYear(), month: s.getMonth()});
        s.setMonth(s.getMonth() + 1);
      }
      return labels;
    }

    function leftPct(date, minDate, maxDate) {
      return (date - minDate) / (maxDate - minDate) * 100;
    }

    function widthPct(start, end, minDate, maxDate) {
      return (end - start) / (maxDate - minDate) * 100;
    }

    async function drawGantt() {
      const response = await fetch('interventions.json');
      const raw = await response.json();
      // Map keys for compatibility
      const interventions = raw.map(item => ({
        goal: item.goal, status: item.status,
        start: item.start_date || item.start,
        end: item.end_date || item.end,
        lead: item.lead, notes: item.notes
      }));

      interventions.forEach(i => {
        i._start = parseDate(i.start);
        i._end = parseDate(i.end);
      });

      // Timeline bounds (add 1mo buffer to each end)
      let minDate = new Date(Math.min(...interventions.map(i=>i._start)));
      let maxDate = new Date(Math.max(...interventions.map(i=>i._end)));
      minDate.setMonth(minDate.getMonth()-1); minDate.setDate(1);
      maxDate.setMonth(maxDate.getMonth()+1); maxDate.setDate(1);

      // X-labels
      const months = getMonthLabels(minDate, maxDate);
      xLabels.innerHTML = '';
      months.forEach(({year, month})=>{
        const d = new Date(year,month,1);
        const div = document.createElement('div');
        div.className = 'x-label';
        div.textContent = d.toLocaleString('default',{month:'short',year:'numeric'});
        xLabels.appendChild(div);
      });

      // Y-labels and gantt rows
      yLabelsDiv.innerHTML = '';
      timelinesDiv.innerHTML = '';
      interventions.forEach((item,idx)=>{
        // Y label
        const yl = document.createElement('div');
        yl.className = 'y-label';
        yl.textContent = item.goal;
        yLabelsDiv.appendChild(yl);

        // Timeline bar row
        const tl = document.createElement('div');
        tl.className = 'gantt-timeline';
        tl.style.width = '100%';
        tl.style.position = 'relative';

        // Bar
        const bar = document.createElement('div');
        bar.className = 'gantt-bar ' + item.status.toLowerCase();
        // calc left and width by pct
        bar.style.left = leftPct(item._start, minDate, maxDate) + '%';
        bar.style.width = widthPct(item._start, item._end, minDate, maxDate) + '%';
        bar.innerHTML = `${item.lead} <span class="badge ${item.status.toLowerCase()}">${item.status}</span>`;

        // Tooltip
        bar.onmouseenter = e => {
          tooltip.innerHTML = `<strong>${item.goal}</strong><br>
          Status: ${item.status}<br>
          Lead: ${item.lead}<br>
          Start: ${item.start}<br>
          End: ${item.end}<br>
          Notes: ${item.notes}`;
          tooltip.style.opacity = '1';
          tooltip.style.left = e.pageX + 12 + 'px';
          tooltip.style.top = e.pageY + 10 + 'px';
        };
        bar.onmousemove = e => {
          tooltip.style.left = e.pageX + 12 + 'px';
          tooltip.style.top = e.pageY + 10 + 'px';
        };
        bar.onmouseleave = ()=>{tooltip.style.opacity=0;};

        tl.appendChild(bar);
        timelinesDiv.appendChild(tl);
      });
    }
    drawGantt();
  </script>
</body>
</html>
